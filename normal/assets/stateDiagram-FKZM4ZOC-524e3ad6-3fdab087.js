import{M,B as G,U as A}from"./chunk-DI55MBZ5-43e572b4-34bef57f.js";import{O as y,b as t,$ as H,ac as U,ao as O,ak as P,m as R,e as E,h as v,G as $}from"./index-51dab561.js";import{L as I}from"./graph-bcc77c87-2962405e.js";import{h as C}from"./layout-9475e452-4ce1ddaa.js";import"./chunk-55IACEB6-ed339123-6f7f014b.js";import"./chunk-QN33PNHL-2c4eac24-0c53cf4d.js";import"./_baseUniq-40c863a3-ba4bbca3.js";import"./_basePickBy-085c36dd-77a779c7.js";var W=y(e=>e.append("circle").attr("class","start-state").attr("r",t().state.sizeUnit).attr("cx",t().state.padding+t().state.sizeUnit).attr("cy",t().state.padding+t().state.sizeUnit),"drawStartState"),F=y(e=>e.append("line").style("stroke","grey").style("stroke-dasharray","3").attr("x1",t().state.textHeight).attr("class","divider").attr("x2",t().state.textHeight*2).attr("y1",0).attr("y2",0),"drawDivider"),J=y((e,n)=>{const g=e.append("text").attr("x",2*t().state.padding).attr("y",t().state.textHeight+2*t().state.padding).attr("font-size",t().state.fontSize).attr("class","state-title").text(n.id),s=g.node().getBBox();return e.insert("rect",":first-child").attr("x",t().state.padding).attr("y",t().state.padding).attr("width",s.width+2*t().state.padding).attr("height",s.height+2*t().state.padding).attr("rx",t().state.radius),g},"drawSimpleState"),Y=y((e,n)=>{const g=y(function(o,f,B){const m=o.append("tspan").attr("x",2*t().state.padding).text(f);B||m.attr("dy",t().state.textHeight)},"addTspan"),s=e.append("text").attr("x",2*t().state.padding).attr("y",t().state.textHeight+1.3*t().state.padding).attr("font-size",t().state.fontSize).attr("class","state-title").text(n.descriptions[0]).node().getBBox(),d=s.height,c=e.append("text").attr("x",t().state.padding).attr("y",d+t().state.padding*.4+t().state.dividerMargin+t().state.textHeight).attr("class","state-description");let l=!0,a=!0;n.descriptions.forEach(function(o){l||(g(c,o,a),a=!1),l=!1});const r=e.append("line").attr("x1",t().state.padding).attr("y1",t().state.padding+d+t().state.dividerMargin/2).attr("y2",t().state.padding+d+t().state.dividerMargin/2).attr("class","descr-divider"),x=c.node().getBBox(),h=Math.max(x.width,s.width);return r.attr("x2",h+3*t().state.padding),e.insert("rect",":first-child").attr("x",t().state.padding).attr("y",t().state.padding).attr("width",h+2*t().state.padding).attr("height",x.height+d+2*t().state.padding).attr("rx",t().state.radius),e},"drawDescrState"),j=y((e,n,g)=>{const s=t().state.padding,d=2*t().state.padding,c=e.node().getBBox(),l=c.width,a=c.x,r=e.append("text").attr("x",0).attr("y",t().state.titleShift).attr("font-size",t().state.fontSize).attr("class","state-title").text(n.id),x=r.node().getBBox().width+d;let h=Math.max(x,l);h===l&&(h=h+d);let o;const f=e.node().getBBox();n.doc,o=a-s,x>l&&(o=(l-h)/2+s),Math.abs(a-f.x)<s&&x>l&&(o=a-(x-l)/2);const B=1-t().state.textHeight;return e.insert("rect",":first-child").attr("x",o).attr("y",B).attr("class",g?"alt-composit":"composit").attr("width",h).attr("height",f.height+t().state.textHeight+t().state.titleShift+1).attr("rx","0"),r.attr("x",o+s),x<=l&&r.attr("x",a+(h-d)/2-x/2+s),e.insert("rect",":first-child").attr("x",o).attr("y",t().state.titleShift-t().state.textHeight-t().state.padding).attr("width",h).attr("height",t().state.textHeight*3).attr("rx",t().state.radius),e.insert("rect",":first-child").attr("x",o).attr("y",t().state.titleShift-t().state.textHeight-t().state.padding).attr("width",h).attr("height",f.height+3+2*t().state.textHeight).attr("rx",t().state.radius),e},"addTitleAndBox"),X=y(e=>(e.append("circle").attr("class","end-state-outer").attr("r",t().state.sizeUnit+t().state.miniPadding).attr("cx",t().state.padding+t().state.sizeUnit+t().state.miniPadding).attr("cy",t().state.padding+t().state.sizeUnit+t().state.miniPadding),e.append("circle").attr("class","end-state-inner").attr("r",t().state.sizeUnit).attr("cx",t().state.padding+t().state.sizeUnit+2).attr("cy",t().state.padding+t().state.sizeUnit+2)),"drawEndState"),q=y((e,n)=>{let g=t().state.forkWidth,s=t().state.forkHeight;if(n.parentId){let d=g;g=s,s=d}return e.append("rect").style("stroke","black").style("fill","black").attr("width",g).attr("height",s).attr("x",t().state.padding).attr("y",t().state.padding)},"drawForkJoinState"),Z=y((e,n,g,s)=>{let d=0;const c=s.append("text");c.style("text-anchor","start"),c.attr("class","noteText");let l=e.replace(/\r\n/g,"<br/>");l=l.replace(/\n/g,"<br/>");const a=l.split(H.lineBreakRegex);let r=1.25*t().state.noteMargin;for(const x of a){const h=x.trim();if(h.length>0){const o=c.append("tspan");if(o.text(h),r===0){const f=o.node().getBBox();r+=f.height}d+=r,o.attr("x",n+t().state.noteMargin),o.attr("y",g+d+1.25*t().state.noteMargin)}}return{textWidth:c.node().getBBox().width,textHeight:d}},"_drawLongText"),K=y((e,n)=>{n.attr("class","state-note");const g=n.append("rect").attr("x",0).attr("y",t().state.padding),s=n.append("g"),{textWidth:d,textHeight:c}=Z(e,0,0,s);return g.attr("height",c+2*t().state.noteMargin),g.attr("width",d+t().state.noteMargin*2),g},"drawNote"),T=y(function(e,n){const g=n.id,s={id:g,label:n.id,width:0,height:0},d=e.append("g").attr("id",g).attr("class","stateGroup");n.type==="start"&&W(d),n.type==="end"&&X(d),(n.type==="fork"||n.type==="join")&&q(d,n),n.type==="note"&&K(n.note.text,d),n.type==="divider"&&F(d),n.type==="default"&&n.descriptions.length===0&&J(d,n),n.type==="default"&&n.descriptions.length>0&&Y(d,n);const c=d.node().getBBox();return s.width=c.width+2*t().state.padding,s.height=c.height+2*t().state.padding,s},"drawState"),L=0,Q=y(function(e,n,g){const s=y(function(r){switch(r){case M.relationType.AGGREGATION:return"aggregation";case M.relationType.EXTENSION:return"extension";case M.relationType.COMPOSITION:return"composition";case M.relationType.DEPENDENCY:return"dependency"}},"getRelationType");n.points=n.points.filter(r=>!Number.isNaN(r.y));const d=n.points,c=U().x(function(r){return r.x}).y(function(r){return r.y}).curve(O),l=e.append("path").attr("d",c(d)).attr("id","edge"+L).attr("class","transition");let a="";if(t().state.arrowMarkerAbsolute&&(a=P(!0)),l.attr("marker-end","url("+a+"#"+s(M.relationType.DEPENDENCY)+"End)"),g.title!==void 0){const r=e.append("g").attr("class","stateLabel"),{x,y:h}=R.calcLabelPosition(n.points),o=H.getRows(g.title);let f=0;const B=[];let m=0,N=0;for(let u=0;u<=o.length;u++){const p=r.append("text").attr("text-anchor","middle").text(o[u]).attr("x",x).attr("y",h+f),w=p.node().getBBox();m=Math.max(m,w.width),N=Math.min(N,w.x),E.info(w.x,x,h+f),f===0&&(f=p.node().getBBox().height,E.info("Title height",f,h)),B.push(p)}let S=f*o.length;if(o.length>1){const u=(o.length-1)*f*.5;B.forEach((p,w)=>p.attr("y",h+w*f-u)),S=f*o.length}const i=r.node().getBBox();r.insert("rect",":first-child").attr("class","box").attr("x",x-m/2-t().state.padding/2).attr("y",h-S/2-t().state.padding/2-3.5).attr("width",m+t().state.padding).attr("height",S+t().state.padding),E.info(i)}L++},"drawEdge"),b,z={},V=y(function(){},"setConf"),_=y(function(e){e.append("defs").append("marker").attr("id","dependencyEnd").attr("refX",19).attr("refY",7).attr("markerWidth",20).attr("markerHeight",28).attr("orient","auto").append("path").attr("d","M 19,7 L9,13 L14,7 L9,1 Z")},"insertMarkers"),tt=y(function(e,n,g,s){b=t().state;const d=t().securityLevel;let c;d==="sandbox"&&(c=v("#i"+n));const l=d==="sandbox"?v(c.nodes()[0].contentDocument.body):v("body"),a=d==="sandbox"?c.nodes()[0].contentDocument:document;E.debug("Rendering diagram "+e);const r=l.select(`[id='${n}']`);_(r);const x=s.db.getRootDoc();D(x,r,void 0,!1,l,a,s);const h=b.padding,o=r.node().getBBox(),f=o.width+h*2,B=o.height+h*2,m=f*1.75;$(r,B,m,b.useMaxWidth),r.attr("viewBox",`${o.x-b.padding}  ${o.y-b.padding} `+f+" "+B)},"draw"),et=y(e=>e?e.length*b.fontSizeFactor:1,"getLabelWidth"),D=y((e,n,g,s,d,c,l)=>{const a=new I({compound:!0,multigraph:!0});let r,x=!0;for(r=0;r<e.length;r++)if(e[r].stmt==="relation"){x=!1;break}g?a.setGraph({rankdir:"LR",multigraph:!0,compound:!0,ranker:"tight-tree",ranksep:x?1:b.edgeLengthFactor,nodeSep:x?1:50,isMultiGraph:!0}):a.setGraph({rankdir:"TB",multigraph:!0,compound:!0,ranksep:x?1:b.edgeLengthFactor,nodeSep:x?1:50,ranker:"tight-tree",isMultiGraph:!0}),a.setDefaultEdgeLabel(function(){return{}});const h=l.db.getStates(),o=l.db.getRelations(),f=Object.keys(h);for(const i of f){const u=h[i];g&&(u.parentId=g);let p;if(u.doc){let w=n.append("g").attr("id",u.id).attr("class","stateGroup");p=D(u.doc,w,u.id,!s,d,c,l);{w=j(w,u,s);let k=w.node().getBBox();p.width=k.width,p.height=k.height+b.padding/2,z[u.id]={y:b.compositTitleSize}}}else p=T(n,u,a);if(u.note){const w={descriptions:[],id:u.id+"-note",note:u.note,type:"note"},k=T(n,w,a);u.note.position==="left of"?(a.setNode(p.id+"-note",k),a.setNode(p.id,p)):(a.setNode(p.id,p),a.setNode(p.id+"-note",k)),a.setParent(p.id,p.id+"-group"),a.setParent(p.id+"-note",p.id+"-group")}else a.setNode(p.id,p)}E.debug("Count=",a.nodeCount(),a);let B=0;o.forEach(function(i){B++,E.debug("Setting edge",i),a.setEdge(i.id1,i.id2,{relation:i,width:et(i.title),height:b.labelHeight*H.getRows(i.title).length,labelpos:"c"},"id"+B)}),C(a),E.debug("Graph after layout",a.nodes());const m=n.node();a.nodes().forEach(function(i){i!==void 0&&a.node(i)!==void 0?(E.warn("Node "+i+": "+JSON.stringify(a.node(i))),d.select("#"+m.id+" #"+i).attr("transform","translate("+(a.node(i).x-a.node(i).width/2)+","+(a.node(i).y+(z[i]?z[i].y:0)-a.node(i).height/2)+" )"),d.select("#"+m.id+" #"+i).attr("data-x-shift",a.node(i).x-a.node(i).width/2),c.querySelectorAll("#"+m.id+" #"+i+" .divider").forEach(u=>{const p=u.parentElement;let w=0,k=0;p&&(p.parentElement&&(w=p.parentElement.getBBox().width),k=parseInt(p.getAttribute("data-x-shift"),10),Number.isNaN(k)&&(k=0)),u.setAttribute("x1",0-k+8),u.setAttribute("x2",w-k-8)})):E.debug("No Node "+i+": "+JSON.stringify(a.node(i)))});let N=m.getBBox();a.edges().forEach(function(i){i!==void 0&&a.edge(i)!==void 0&&(E.debug("Edge "+i.v+" -> "+i.w+": "+JSON.stringify(a.edge(i))),Q(n,a.edge(i),a.edge(i).relation))}),N=m.getBBox();const S={id:g||"root",label:g||"root",width:0,height:0};return S.width=N.width+2*b.padding,S.height=N.height+2*b.padding,E.debug("Doc rendered",S,a),S},"renderDoc"),at={setConf:V,draw:tt},ht={parser:G,get db(){return new M(1)},renderer:at,styles:A,init:y(e=>{e.state||(e.state={}),e.state.arrowMarkerAbsolute=e.arrowMarkerAbsolute},"init")};export{ht as diagram};
